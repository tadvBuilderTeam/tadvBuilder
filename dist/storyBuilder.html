<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Choose Your Own Adventure</title>
<style>/* Globals */
:root {
    --color-text: #1e293b;        /* primary textcolor */
    --color-background: #f8fafc;  /* Background */
    --color-highlight-background: #c6d9e8;
    --color-transparent-background: rgba(0, 0, 0, 0.5);
    --color-foreground: #3b82f6;  /* accent color (e.g. buttons, links) */
    --color-accent: #0ea5e9;      /* secondary accent color for details */

    --color-success: #166534;
    --color-error: #9b2c2c;
}

:root[data-theme="warm"] {
    --color-text: #3a2f2a;
    --color-background: #faf5f1;
    --color-highlight-background: #eee4dd;
    --color-foreground: #b48a76;
    --color-accent: #d4a98c;

    --color-success: #3c6f57;
    --color-error: #9a4a3f;
}

body {
    font-family: system-ui, sans-serif;
    margin: 2rem;
    line-height: 1.6;

    background-color: var(--color-background);
    color: var(--color-text);
}
h1, h2 {
    color: var(--color-text);
}
textarea, input, select {
    display: block;
    margin-top: 0.5rem;
    margin-bottom: 1rem;
    width: 100%;
    padding: 0.6rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid var(--color-foreground);
    box-sizing: border-box;
}
input[type="text"]::before, textarea::before {
    font-family: inherit;
}
label {
    margin-top: 1rem;
    font-weight: bold;
}
button {
    background-color: var(--color-foreground);
    color: var(--color-background);
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 500;
}
button:hover {
    background-color: var(--color-accent);
}
input[type="checkbox"] {
    margin-right: 0.5em;
    width: 1.2em;
    height: 1.2em;
}

.section {
    background: var(--color-background);;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.sectionHighlighted {
    background-color: var(--color-highlight-background);
    border-left: 5px solid var(--color-accent);
}
.bluesidebarP {
    font-size: 0.875rem;
    background-color: var(--color-foreground);
    padding: 0.5rem 1rem;
    border-left: 4px solid var(--color-foreground);
    border-radius: 4px;
    margin-bottom: 1rem;
}

.feedback-success {
    color: var(--color-success);
}

.feedback-error {
    color: var(--color-error);
}
.choice-inputs {
    margin-bottom: 1rem;
    display: grid;
    gap: 0.5rem;
}
.help {
    font-size: 0.875rem;
    color: var(--color-text);
    margin-top: -0.5rem;
    margin-bottom: 0.5rem;
}

.intro {
    padding: 1rem;
    margin-bottom: 2rem;
    border-radius: 8px;
    font-size: 0.9rem;
}
.intro h1 {
    font-size: 2rem;
    color: var(--color-foreground);
    margin-bottom: 0.25rem;
}
.intro h2 {
    margin-top: -0.5rem;
    color: var(--color-text);
    font-weight: normal;
    font-size: 1.2rem;
}
.checkbox-container {
    display: flex;
    align-items: center;
    margin-top: 1rem;
}

.checkbox-container label {
    margin: 0;
    font-weight: normal;
}

#output, #preview, #play-area, #tree-output {
    background: var(--color-background);
    border: 1px solid var(--color-foreground);
    padding: 1rem;
    border-radius: 8px;
    white-space: pre-wrap;
    font-family: ui-monospace, SFMono-Regular, monospace;
}

#play-area button {
    margin-top: 0.5rem;
}

/* -------------------------------- TreeEditor styles --------------------------------------------- */
.story-tree {
    list-style: none;
    padding-left: 0.75rem;
}
.tree-node-header {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    position: relative;
}
.tree-node {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}
.tree-node-preview {
    opacity: 0.7;
    font-style: italic;
}
.tree-toggle {
    min-width: 1.5rem;
    height: 1.5rem;
    padding: 0 0.25rem;
    line-height: 1.2rem;
}
.tree-toggle-spacer {
    display: inline-block;
    width: 1.5rem;
    height: 1.5rem;
}
.tree-delete {
    visibility: hidden; /* only show on hover */
    background-color: transparent;
    color: var(--color-text);
    border: 1px solid transparent;
    margin-left: 0.25rem;
}
.tree-node-header:hover .tree-delete {
    visibility: visible;
    border-color: var(--color-foreground);
}
.tree-addscene-btn {
    visibility: visible;
    background-color: transparent;
    color: var(--color-success);
    border: 1px solid var(--color-foreground);
    margin-left: 0.25rem;
}
.tree-node-header:hover .tree-addscene-btn {
    visibility: visible;
}
.tree-edge {
    color: var(--color-text);
    opacity: 0.8;
}

/* ------------------------------- Popup Input Mask ----------------------------------------- */
.popup {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: var(--color-transparent-background);
    padding-top: 100px;
}

.popup-content {
    background-color: var(--color-background);
    margin: 1% auto;
    padding: 20px;
    border: 1px solid var(--color-accent);
    width: 50%;
    max-height: 80%;
    overflow-y: auto; /* vertical scrolling */
    text-align: center;
    position: relative;
}

.close {
    color: var(--color-error);
    font-size: 36px;
    font-weight: bold;
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: pointer;
    transition: transform 0.3s;
}

.close:hover {
    transform: scale(1.2);
}

.choiceform-delete {
    color: var(--color-text);
    border: 1px solid transparent;
    margin-left: 0.25rem;
    width: 2rem;
    height: 2rem;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}</style>
</head>
<body>

<div id="intro" class="intro sectionHighlighted">
    <h1>Choose Your Own Adventure</h1>
    <h2>Ein Tool zum Schreiben verzweigter Entscheidungsgeschichten direkt im Browser</h2>
    <p>Dieses Tool hilft dir beim Erstellen von verzweigten Erlebnissen: sogenannte "Entscheidungsgeschichten".
        Leserinnen und Leser k√∂nnen durch ihre Entscheidungen den Verlauf beeinflussen. Jede Szene bekommt einen eindeutigen Schl√ºsselnamen,
        einen Text und eine oder mehrere Auswahlm√∂glichkeiten, die zu anderen Szenen f√ºhren. Du kannst Szenen anlegen, verkn√ºpfen,
        Vorschauen anzeigen lassen und am Ende das komplette Story-Konstrukt als JSON weiterverwenden oder speichern - alles direkt im Browser, komplett offline und lokal.</p>
    <p>Design-Theme:</p>
    <label for="theme-select"></label><select id="theme-select">
        <option value="default">Standard</option>
        <option value="warm">Warm Neutral</option>
    </select>
</div>

<div id="tree-html-section" class="section">
    <h2>Entscheidungsbaum (HTML-Ansicht)</h2>
    <button id="btn-html-tree-refresh">HTML-Baum aktualisieren</button>
    <div id="tree-html-area"></div>
    <!-- After each rendering, all content gets replaced. -->
</div>

<div class="content" style="text-align: center; margin-top: 50px;">
    <p>Mit dem Szeneneditor lassen sich Szenen erstellen, oder Szeneninhalte √§ndern. </p>
    <button id="showCreatorBtn">Neue Szene</button>
    <button id="showEditorBtn">Szene √§ndern</button>
</div>

<div class="popup" id="create-scene-popup">
    <div class="popup-content">
        <span class="close" id="creator-closeBtn">&times;</span>
        <div id="scene-creator" class="section">
            <h2>Szene anlegen:</h2>
            <label>Schl√ºsselname der Szene:<span class="help">Ein eindeutiger Bezeichner, z.‚ÄØB. <code>start</code> oder <code>kapitel1</code></span></label>
            <label for="creator-scene-key"></label><input type="text" id="creator-scene-key" placeholder="z.‚ÄØB. start">

            <label>Text der Szene:<span class="help">Der eigentliche Erz√§hltext, der dem Leser angezeigt wird</span></label>
            <label for="creator-scene-text"></label><textarea id="creator-scene-text" rows="4" placeholder="Hier deine Szene eingeben..."></textarea>

            <label>Entscheidungen:<span class="help">Welche M√∂glichkeiten der Leser hat und wohin sie f√ºhren</span></label>
            <div id="creator-choices-container">
                <div class="choice-inputs">
                    <input type="text" class="choice-text" placeholder="Entscheidungstext">
                    <input type="text" class="choice-next" placeholder="N√§chste Szene (Schl√ºssel)">
                </div>
            </div>
            <button id="creator-add-choice-btn">Weitere Entscheidung hinzuf√ºgen</button>
            <button id="creator-submit-btn">Szene speichern</button>
            <pre id="creator-scene-status">(noch keine Aktion durchgef√ºhrt)</pre>
        </div>
    </div>
</div>

<div class="popup" id="edit-scene-popup">
    <div class="popup-content">
        <span class="close" id="editor-closeBtn">&times;</span>
        <div id="scene-editor" class="section">
            <h2>Szene bearbeiten:</h2>
            <label>Schl√ºsselname der Szene:<span class="help">Ein eindeutiger Bezeichner, z.‚ÄØB. <code>start</code> oder <code>kapitel1</code></span></label>
            <label for="editor-scene-key"></label><input type="text" id="editor-scene-key" placeholder="z.‚ÄØB. start">

            <label>Text der Szene:<span class="help">Der eigentliche Erz√§hltext, der dem Leser angezeigt wird</span></label>
            <label for="editor-scene-text"></label><textarea id="editor-scene-text" rows="4" placeholder="Hier deine Szene eingeben..."></textarea>

            <label>Entscheidungen:<span class="help">Welche M√∂glichkeiten der Leser hat und wohin sie f√ºhren</span></label>
            <div id="editor-choices-container">
                <div class="choice-inputs">

                </div>
            </div>
            <button id="editor-add-choice-btn">Weitere Entscheidung hinzuf√ºgen</button>
            <button id="editor-submit-btn">Szene speichern</button>
            <pre id="editor-scene-status">(noch keine Aktion durchgef√ºhrt)</pre>
        </div>
    </div>
</div>

<div id="play-section" class="section">
    <h2>Interaktive Vorschau</h2>
    <p class="help">Die Geschichte wird ab der Szene mit dem Schl√ºssel <code>start</code> gestartet</p>
    <button id="start-story">Geschichte starten</button>
    <div id="play-area"></div>
</div>

<div id="tree-section" class="section">
    <h2>Entscheidungsbaum (ASCII-√úbersicht)</h2>
    <p class="help">Diese einfache Textdarstellung zeigt, welche Szene zu welcher f√ºhrt. Sie wird automatisch aus deinem Story-Aufbau generiert.</p>
    <pre id="tree-output">(noch kein Baum erstellt)</pre>
    <button id="btn-ascii-tree-refresh">Entscheidungsbaum aktualisieren</button>
</div>

<div id="import-export-section" class="section">
    <h2><span class="emoji"></span> Geschichte importieren / exportieren</h2>
    <p class="help">Lade eine bestehende Geschichte (JSON) oder exportiere deine aktuelle Arbeit.</p>

    <label for="json-file">JSON-Datei laden:</label>
    <input type="file" id="json-file" accept=".json" />
    <button id="import-json">Importieren von JSON</button>
    <button id="export-json">Exportieren als JSON</button>
    <button id="export-html">Exportieren als HTML</button>

    <div class="checkbox-container">
        <input type="checkbox" id="export-antiscraping-check">
        <label for="export-antiscraping-check">Kopierschutz</label>
    </div>
    <br>Kopierschutz dient haupts√§chlich gegen Webscraper. Nur bei export als html m√∂glich.

    <pre id="import-status">(kein Import durchgef√ºhrt)</pre>
</div>

<script>var h=class g{constructor(e,t="",n=null,o=null){if(this.key=e,this.text=t,this.parent=n,this.choices=new Map,o instanceof Map)for(let[c,s]of o)this.choices.set(c,s);else if(Array.isArray(o))for(let c of o)c.next&&c.text&&this.choices.set(c.next,c.text)}addChoice(e,t){return this.choices.has(t)?!1:(this.choices.set(t,e),!0)}updateContent(e,t=null){let n=!1;return typeof e=="string"&&e.trim()!==""&&(this.text=e,n=!0),this.choicesAreEqual(t)||(t instanceof Map&&t?(this.choices=t,n=!0):t===null&&(this.choices.clear(),n=!0)),n}updateChoiceText(e,t){return this.choices.has(e)?(this.choices.set(e,t),!0):!1}removeChoice(e){return this.choices.delete(e)}getAllChoices(){return Array.from(this.choices,([e,t])=>({text:t,next:e}))}choicesAreEqual(e){if(!e||this.choices.size!==e.size)return!1;for(let[t,n]of this.choices)if(e.get(t)!==n)return!1;return!0}static fromJson(e,t){if(!e||!t)return null;let n=null;if(typeof t=="string")try{n=JSON.parse(t)}catch(c){return console.error(`Failed to parse JSON for scene ${e}: ${c}`),null}else if(typeof t=="object")n=t;else return console.error(`Failed to parse JSON for scene ${e}: Invalid JSON type`),null;if(!n.text||typeof n.text!="string")return console.error(`Scene ${e} missing text property.`),null;let o=new g(e,n.text,null,[]);if(Array.isArray(n.choices))for(let c of n.choices)!c||typeof c.text!="string"||typeof c.next!="string"||o.addChoice(c.text,c.next);return o}toJSON(){let e=[];for(let[t,n]of this.choices.entries())e.push({text:n,next:t});return e.length===0?{text:this.text}:{text:this.text,choices:e}}};var m=class g{constructor(){this.scenes=new Map,this.root=null}addScene(e){if(this.scenes.has(e.key))return!1;if(this.scenes.set(e.key,e),!this.root)return this.root=e,!0;if(!e.parent&&this.root&&this.scenes.size>0){let t=this.findParent(e.key);t?(e.parent=t,t.addChoice(e.text||`to ${e.key}`,e.key)):(this.root.addChoice(e.text||`to ${e.key}`,e.key),e.parent=this.root)}return e.parent&&this.scenes.has(e.parent.key)&&this.scenes.get(e.parent.key).addChoice(e.text||`to ${e.key}`,e.key),!0}findParent(e){for(let t of this.scenes.values())if(t.choices instanceof Map&&t.choices.has(e))return t;return null}getScene(e){return this.scenes.get(e)||null}static getSceneDepth(e,t){if(!e.has(t.key))return-1;let n=0,o=t;for(;o&&o.parent;)n++,o=o.parent;return n}static getScenesDFS(e,t=e.root){if(!e||!t)return[];let n=[],o=[],c=new Set,s=0;for(t!==e.root&&(s=g.getSceneDepth(e.scenes,t)),o.push({scene:t,depth:s});o.length>0;){let{scene:r,depth:i}=o.pop();if(c.has(r.key))continue;c.add(r.key),n.push({key:r.key,scene:r,depth:i});let I=Array.from(r.choices.keys()).map(l=>e.getScene(l)).filter(l=>l&&!c.has(l.key));for(let l=I.length-1;l>=0;l--)o.push({scene:I[l],depth:i+1})}return n}static hasCircle(e){let t=new Set,n=g.getScenesDFS(e);for(let{scene:o}of n)if(o){for(let c of o.choices.keys()){let s=e.getScene(c);if(s&&t.has(s.key))return!0}t.add(o.key)}return!1}editScene(e,t,n){let o=this.scenes.get(e);return o?o.updateContent(t,n):(console.warn(`Scene ${e} not found`),!1)}changeSceneParent(e,t){let n=this.scenes.get(e);n||console.warn(`Scene ${e} not found`);let o=n.parent.choices.get(n.key).text;n.parent.removeChoice(n.key);let c=this.scenes.get(t);return c?(n.parent=c,c.addChoice(o||`to ${n.key}`,n.key),!0):(n.parent=null,!1)}removeScene(e){let t=this.scenes.get(e);if(!t)return console.warn(`Scene ${e} not found`),!1;t.parent&&t.parent.removeChoice(t.key);let n=g.getScenesDFS(this,t);for(let o=n.length-1;o>=0;o--){let{key:c}=n[o];this.scenes.delete(c)}return!0}toJSON(){let e={};for(let[t,n]of this.scenes.entries())e[t]=n.toJSON();return e}static fromJson(e){if(!e||typeof e!="object")return null;let t=new g(h);for(let[n,o]of Object.entries(e)){let c=h.fromJson(n,o);if(c)t.addScene(c);else return console.warn(`Failed to load scene ${n}`),null}return t.scenes.size===0?(console.warn("No scenes found in JSON"),null):t}};var b=class g{constructor(){throw new Error("Static class")}static async loadFromJson(e){if(!e||typeof e!="string")return null;let t=null;try{let n=await fetch(e);if(!n.ok)return null;t=await n.json()}catch{return null}return typeof m.fromJson!="function"?(console.warn("Story has no method called: fromJson"),null):m.fromJson(t)}static async saveToJson(e,t){if(!e||!t||typeof t!="string")return console.error("Ung√ºltige Eingabeparameter in saveToJson: story = ",e,", filename = ",t),!1;let n=e.toJSON();try{let o=JSON.stringify(n),c=new Blob([o],{type:"text/json"}),s=document.createElement("a");s.href=URL.createObjectURL(c),s.download=t,s.click(),URL.revokeObjectURL(s.href),console.log("Story saved to Json")}catch(o){return console.error("Failed to save story to Json:"+o),!1}return!0}static async saveToHtml(e,t){if(!e||!t||typeof t!="string")return console.error("Ung√ºltige Eingabeparameter in saveToHtml: story = ",e,", filename = ",t),!1;let n="PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImRlIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8dGl0bGU+U3RvcnktVmlld2VyPC90aXRsZT4KICAgIDxzdHlsZT4KICAgICAgICBib2R5IHsKICAgICAgICAgICAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgc2Fucy1zZXJpZjsKICAgICAgICB9CiAgICAgICAgaDIgewogICAgICAgICAgICBjb2xvcjogIzBmMTcyYTsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMC4yNXJlbTsKICAgICAgICB9CiAgICAgICAgI2dhbWUgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjFmNWY5OwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjY2JkNWUxOwogICAgICAgICAgICBwYWRkaW5nOiAxcmVtOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIG1hcmdpbjogMCBhdXRvOwogICAgICAgICAgICBtYXgtd2lkdGg6IDgwMHB4OwogICAgICAgICAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDEycHggcmdiYSgwLDAsMCwwLjA2KTsKICAgICAgICB9CiAgICAgICAgI2dhbWUgYnV0dG9uIHsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogIzNiODJmNjsKICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICBwYWRkaW5nOiAwLjZyZW0gMXJlbTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi10b3A6IDAuNXJlbTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgICAgICB9CiAgICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5Pgo8ZGl2IGlkPSJnYW1lIj48L2Rpdj4KCjxzY3JpcHQ+CiAgICBjb25zdCBzdG9yeSA9IHsKICAgICAgICAvLyBJTlNFUlQgSlNPTiBTVE9SWSBIRVJFCg==",o="ICAgIH07CgogICAgZnVuY3Rpb24gc2hvd1NjZW5lKGtleSkKICAgIHsKICAgICAgICBjb25zdCBzY2VuZSA9IHN0b3J5W2tleV07CiAgICAgICAgaWYgKCFzY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZ2FtZSIpOwogICAgICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAiIjsgLy8gZGVsZXRlIHByZXZpb3VzIGNvbnRlbnQvc2NlbmUKCiAgICAgICAgY29uc3QgdGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJoMiIpOwogICAgICAgIHRpdGxlLnRleHRDb250ZW50ID0ga2V5OyBjb250YWluZXIuYXBwZW5kQ2hpbGQodGl0bGUpOwoKICAgICAgICBjb25zdCB0ZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicCIpOwogICAgICAgIHRleHQudGV4dENvbnRlbnQgPSBzY2VuZS50ZXh0OyBjb250YWluZXIuYXBwZW5kQ2hpbGQodGV4dCk7CgogICAgICAgIGlmICghc2NlbmUuY2hvaWNlcyB8fCBzY2VuZS5jaG9pY2VzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICBmb3IgKGNvbnN0IGMgb2Ygc2NlbmUuY2hvaWNlcykgewogICAgICAgICAgICBjb25zdCBidXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgICAgICAgICAgYnV0dG9uLnRleHRDb250ZW50ID0gYy50ZXh0OwogICAgICAgICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiBzaG93U2NlbmUoYy5uZXh0KSk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChidXR0b24pOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnIiKSk7CiAgICAgICAgfQogICAgfQoKICAgIHNob3dTY2VuZSgic3RhcnQiKTsKPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPg==",c=e.toJSON(),s=JSON.stringify(c);s=s.slice(1,-1);try{let r=window.atob(n)+s+window.atob(o),i=new Blob([r],{type:"text/html"}),I=document.createElement("a");I.href=URL.createObjectURL(i),I.download=t,I.click(),URL.revokeObjectURL(I.href),console.log("Story saved to Html")}catch(r){return console.error("Failed to save story to Json:"+r),!1}return!0}static async saveToEncryptedHtml(e,t,n){if(!e||!t||typeof t!="string"||!n)return console.error("Ung√ºltige Parameter in saveToEncryptedHtml"),!1;let o="PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImRlIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8dGl0bGU+T2JmdXNjYXRlZCBTdG9yeS1WaWV3ZXI8L3RpdGxlPgogICAgPHN0eWxlPgogICAgICAgIGJvZHkgewogICAgICAgICAgICBmb250LWZhbWlseTogc3lzdGVtLXVpLCBzYW5zLXNlcmlmOwogICAgICAgIH0KICAgICAgICBoMiB7CiAgICAgICAgICAgIGNvbG9yOiAjMGYxNzJhOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAwLjI1cmVtOwogICAgICAgIH0KICAgICAgICAjZ2FtZSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmMWY1Zjk7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNjYmQ1ZTE7CiAgICAgICAgICAgIHBhZGRpbmc6IDFyZW07CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgbWFyZ2luOiAwIGF1dG87CiAgICAgICAgICAgIG1heC13aWR0aDogODAwcHg7CiAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggMTJweCByZ2JhKDAsMCwwLDAuMDYpOwogICAgICAgIH0KICAgICAgICAjZ2FtZSBidXR0b24gewogICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjM2I4MmY2OwogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuNnJlbSAxcmVtOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMC41cmVtOwogICAgICAgICAgICBmb250LXdlaWdodDogNTAwOwogICAgICAgIH0KICAgIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CjxkaXYgaWQ9ImdhbWUiPjwvZGl2PgoKPHNjcmlwdD4KICAgIC8vID09PSBjb25maWcgPT09CiAgICBjb25zdCBFTkNSWVBURURfU1RPUlkgPSAi",c="IjsKICAgIGNvbnN0IERFQ1JZUFRJT05fS0VZID0gIg==",s="IjsKCiAgICBsZXQgc3RvcnkgPSBudWxsOwoKICAgIGZ1bmN0aW9uIHNob3dTY2VuZShrZXkpCiAgICB7CiAgICAgICAgY29uc3Qgc2NlbmUgPSBzdG9yeVtrZXldOwogICAgICAgIGlmICghc2NlbmUpIHJldHVybjsKCiAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImdhbWUiKTsKICAgICAgICBjb250YWluZXIuaW5uZXJIVE1MID0gIiI7IC8vIGRlbGV0ZSBwcmV2aW91cyBjb250ZW50L3NjZW5lCgogICAgICAgIGNvbnN0IHRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaDIiKTsKICAgICAgICB0aXRsZS50ZXh0Q29udGVudCA9IGtleTsgY29udGFpbmVyLmFwcGVuZENoaWxkKHRpdGxlKTsKCiAgICAgICAgY29uc3QgdGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInAiKTsKICAgICAgICB0ZXh0LnRleHRDb250ZW50ID0gc2NlbmUudGV4dDsgY29udGFpbmVyLmFwcGVuZENoaWxkKHRleHQpOwoKICAgICAgICBpZiAoIXNjZW5lLmNob2ljZXMgfHwgc2NlbmUuY2hvaWNlcy5sZW5ndGggPT09IDApIHJldHVybjsKCiAgICAgICAgZm9yIChjb25zdCBjIG9mIHNjZW5lLmNob2ljZXMpIHsKICAgICAgICAgICAgY29uc3QgYnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICAgICAgICAgIGJ1dHRvbi50ZXh0Q29udGVudCA9IGMudGV4dDsKICAgICAgICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCkgPT4gc2hvd1NjZW5lKGMubmV4dCkpOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoYnV0dG9uKTsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJyIikpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBYT1IgZGVjcnlwdGlvbiB3aXRoIHBvc2l0aW9uIG1peGluZwogICAgZnVuY3Rpb24gZGVjcnlwdFN0b3J5KGVuY3J5cHRlZEhleCwga2V5KSB7CiAgICAgICAgaWYoIWVuY3J5cHRlZEhleCB8fCBlbmNyeXB0ZWRIZXgubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkVuY3J5cHRlZCBzdG9yeSBvciBrZXkgbm90IGZvdW5kLiIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gSGV4IGRlY29kZQogICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWQgPSBuZXcgVWludDhBcnJheShlbmNyeXB0ZWRIZXgubGVuZ3RoIC8gMik7CiAgICAgICAgICAgIGxldCBieXRlSW5kZXggPSAwOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVuY3J5cHRlZEhleC5sZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICAgICAgZW5jcnlwdGVkW2J5dGVJbmRleCsrXSA9IHBhcnNlSW50KGVuY3J5cHRlZEhleC5zbGljZShpLCBpICsgMiksIDE2KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3Qga2V5Qnl0ZXMgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoa2V5KTsKCiAgICAgICAgICAgIGNvbnN0IGRlY3J5cHRlZCA9IG5ldyBVaW50OEFycmF5KGVuY3J5cHRlZC5sZW5ndGgpOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVuY3J5cHRlZC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgZGVjcnlwdGVkW2ldID0gZW5jcnlwdGVkW2ldIF4ga2V5Qnl0ZXNbaSAlIGtleUJ5dGVzLmxlbmd0aF0gXiAoaSAmIDB4RkYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBqc29uU3RyaW5nID0gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKGRlY3J5cHRlZCk7CiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKGpzb25TdHJpbmcpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcigiRGVjcnlwdGlvbiBvZiBzdG9yeSBmYWlsZWQ6IiwgZSk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBJbml0aWFsaXplIGdhbWUgd2l0aCBhc3luYy9hd2FpdAogICAgYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZUdhbWUoKSB7CiAgICAgICAgY29uc29sZS5sb2coIkluaXRpYWxpemluZyBnYW1lLi4uIik7CgogICAgICAgIHN0b3J5ID0gYXdhaXQgZGVjcnlwdFN0b3J5KEVOQ1JZUFRFRF9TVE9SWSwgREVDUllQVElPTl9LRVkpOwogICAgICAgIHN0b3J5ID0gSlNPTi5wYXJzZShzdG9yeSk7CiAgICAgICAgCiAgICAgICAgaWYgKCFzdG9yeSkgewogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZ2FtZSIpOwogICAgICAgICAgICBjb250YWluZXIuaW5uZXJIVE1MID0gIjxwPkVycm9yOiBDb3VsZCBub3QgbG9hZCB0aGUgc3RvcnkuPC9wPiI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnNvbGUubG9nKCJEaXNwbGF5aW5nIGZpcnN0IHNjZW5lLi4uIik7CiAgICAgICAgc2hvd1NjZW5lKCJzdGFydCIpOwogICAgfQoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKSA9PiB7CiAgICAgICAgaW5pdGlhbGl6ZUdhbWUoKS5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yIGluaXRpYWxpemluZyBnYW1lOiIsIGVycm9yKTsKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImdhbWUiKTsKICAgICAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICI8cD5BbiBlcnJvciBvY2N1cnJlZC4gUGxlYXNlIGNoZWNrIHRoZSBjb25zb2xlIGZvciBkZXRhaWxzLjwvcD4iOwogICAgICAgIH0pOwogICAgfSk7CgogICAgc3RvcnkgPSBkZWNyeXB0U3RvcnkoRU5DUllQVEVEX1NUT1JZLCBERUNSWVBUSU9OX0tFWSk7CiAgICBzaG93U2NlbmUoInN0YXJ0Iik7Cjwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4=",r=e.toJSON(),i=JSON.stringify(r),I=g.#e(i,n);try{let l=window.atob(o)+`${I}`+window.atob(c)+`${n}`+window.atob(s),C=new Blob([l],{type:"text/html"}),u=document.createElement("a");return u.href=URL.createObjectURL(C),u.download=t,u.click(),URL.revokeObjectURL(u.href),console.log("Encrypted story saved to HTML"),!0}catch(l){return console.error("Failed to save encrypted story: "+l),!1}}static#e(e,t){let n=JSON.stringify(e),o=new TextEncoder().encode(n),c=new TextEncoder().encode(t),s=new Uint8Array(o.length);for(let i=0;i<o.length;i++)s[i]=o[i]^c[i%c.length]^i&255;let r="";for(let i=0;i<s.length;i++){let I=s[i].toString(16).padStart(2,"0");r+=I}return r}};var f=class{static generateTreeAscii(e,t=document.getElementById("tree-output")){if(console.log("StoryTreeRenderer.generateTreeAscii. Parent: "+t.id+" Story: "+e.root.key),!t)return;if(!e||!e.root){t.textContent="(noch kein Baum erstellt)";return}let n=m.getScenesDFS(e,e.root),o=[];for(let s=0;s<n.length;s++){let{key:r,scene:i,depth:I}=n[s],l="";for(let C=0;C<I;C++)l+=C===I-1?"|_ ":"   ";r=String(r),i===null?o.push(l+"["+r+"](MISSING)"):o.push(l+r)}let c=o.join(`
`);t.textContent=c}};var a=class{static show(e,t,n,o="create"){if(!t)return;let c=n?"feedback-success":"feedback-error";if(o==="create"){let s=document.createElement("div");s.textContent=e,s.classList.add("feedback",c),t.appendChild(s),setTimeout(()=>s.remove(),3e3)}else o==="set"&&(t.textContent=e,t.classList.add("feedback",c))}};var p=class g{static render(e,t,n="play-area"){let o=document.getElementById(n);if(!o)return;let c=e.getScene(t);if(o.innerHTML="",!c){let i=document.createElement("p"),I=document.createElement("em");I.textContent="Szene '"+t+"' nicht gefunden.",i.appendChild(I),o.textContent="",o.appendChild(i);return}let s=document.createElement("p"),r=document.createElement("strong");r.textContent=t,s.append(r,": "+c.text),o.appendChild(s);for(let[i,I]of c.choices.entries()){let l=document.createElement("button");l.textContent=I,l.onclick=()=>g.render(e,i,n),o.appendChild(l),o.appendChild(document.createElement("br"))}}};var y=class g{static#e=new Map;static#c(e){return this.#e.has(e)||this.#e.set(e,new g(e)),this.#e.get(e)}static render(e,t="tree-html-area"){g.#c(t).render(e)}constructor(e){this.targetElementId=e,this.expanded=new Set}render(e){let t=this.#s();if(!t)return;if(this.#i(t),!this.#r(e)){this.#g(t);return}this.#l(e);let n=this.#I();this.#t(e.root.key,n,e,new Set),t.appendChild(n)}#s(){let e=document.getElementById(this.targetElementId);return e||console.warn(`TreeEditor: container with id "${this.targetElementId}" not found.`),e}#i(e){e.innerHTML=""}#r(e){return!!(e&&e.root)}#g(e){let t=document.createElement("p");t.textContent='Keine Startszene gefunden. Lege zuerst eine Szene mit dem Schl√ºssel "start" an.',e.appendChild(t)}#l(e){this.expanded.has(e.root.key)||this.expanded.add(e.root.key)}#I(){let e=document.createElement("ul");return e.classList.add("story-tree"),e}#t(e,t,n,o){let c=document.createElement("li"),s=n.getScene(e);if(!s){c.textContent=`${e} (Szene nicht gefunden)`;let C=this.#h(e,n);C.classList.add("tree-addscene-btn"),c.appendChild(C),t.appendChild(c);return}let r=this.#C(e,s,n);if(c.appendChild(r),t.appendChild(c),o.has(e)){let C=document.createElement("em");C.textContent=" (Zyklus)",c.appendChild(C);return}if(!this.#n(s)||!this.#o(e))return;let I=document.createElement("ul");c.appendChild(I);let l=new Set(o);l.add(e);for(let[C,u]of s.choices.entries()){let A=document.createElement("li"),Z=document.createElement("span");Z.classList.add("tree-edge"),Z.textContent=`‚Üí ${u}`,A.appendChild(Z);let G=document.createElement("ul");A.appendChild(G),I.appendChild(A),this.#t(C,G,n,l)}}#C(e,t,n){let o=document.createElement("div");o.classList.add("tree-node-header");let c=n&&n.root&&n.root.key===e;if(!c&&this.#n(t)){let r=this.#d(e,n);o.appendChild(r)}else o.appendChild(this.#a());let s=this.#u(e,t);if(o.appendChild(s),!c){let r=this.#A(e,n);s.appendChild(r)}return o}#d(e,t){let n=this.#o(e),o=document.createElement("button");return o.classList.add("tree-toggle"),o.setAttribute("aria-label",n?"Einklappen":"Ausklappen"),o.setAttribute("aria-expanded",String(n)),o.textContent=n?"‚àí":"+",o.addEventListener("click",c=>this.#m(c,e,t)),o}#a(){let e=document.createElement("span");return e.classList.add("tree-toggle-spacer"),e}#u(e,t){let n=document.createElement("span");n.classList.add("tree-node");let o=document.createElement("strong");return o.textContent=e,n.appendChild(o),n}#A(e,t){let n=document.createElement("button");return n.classList.add("tree-delete"),n.setAttribute("aria-label",`Szene "${e}" l√∂schen`),n.textContent="üóë",n.addEventListener("click",o=>{if(o.preventDefault(),o.stopPropagation(),!confirm(`Soll die Szene "${e}" wirklich gel√∂scht werden?`))return;if(!t.removeScene(e)){console.warn(`TreeEditor: Szene "${e}" konnte nicht gel√∂scht werden.`);return}this.expanded.delete(e),this.render(t)}),n}#h(e){let t=document.createElement("button");return t.classList.add("tree-add"),t.setAttribute("aria-label",`Szene "${e}" hinzuf√ºgen`),t.textContent="+",t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();let o=document.getElementById("creator-scene-key");o.value=e;let c=document.getElementById("create-scene-popup");c.style.display="block"}),t}#m(e,t,n){e.preventDefault(),e.stopPropagation(),this.#p(t),this.render(n)}#n(e){return!!(e.choices&&e.choices.size)}#o(e){return this.expanded.has(e)}#p(e){this.expanded.has(e)?this.expanded.delete(e):this.expanded.add(e)}};var B=class g{constructor(e){this.story=e}static addScene(e){let t=document.getElementById("creator-scene-key").value.trim(),n=document.getElementById("creator-scene-text").value.trim(),o=document.getElementById("scene-creator");if(!t||!n){a.show("Bitte Schl√ºssel und Text ausf√ºllen.",o,!1);return}let c=document.getElementById("creator-choices-container"),s=Array.from(c.querySelectorAll(".choice-inputs")),r=new Map;if(s.forEach(I=>{let l=I.querySelector(".choice-text"),C=I.querySelector(".choice-next");C||console.log("No input for next scene key found. ");let u=l.value.trim(),A=C.value.trim();u&&A&&r.set(A,u)}),!e.addScene(new h(t,n,null,r))){a.show("Scene could not be added to story, key already exists.",o,!1);return}p.render(e,t),f.generateTreeAscii(e),y.render(e),document.getElementById("creator-scene-key").value="",document.getElementById("creator-scene-text").value="";let i=document.getElementById("creator-choices-container");i.innerHTML=`<div class="choice-inputs">
    <input type="text" class="choice-text" placeholder="Entscheidungstext">
    <input type="text" class="choice-next" placeholder="N√§chste Szene (Schl√ºssel)">
    </div>`,a.show("Szene wurde gespeichert.",o,!0)}static editScene(e){let t=document.getElementById("editor-scene-key"),n=document.getElementById("editor-scene-status"),o=document.getElementById("editor-scene-text"),c=document.getElementById("editor-choices-container"),s=t.value.trim(),r=o.value.trim();if(!s){a.show("Bitte gib den Schl√ºssel der zu bearbeitenden Szene ein.",n,!1);return}let i=new Map;for(let l of c.children){if(!l.classList.contains("choice-inputs"))continue;let C=l.querySelector(".choice-text"),u=l.querySelector(".choice-next");if(!C||!u||!(C instanceof HTMLInputElement)||!(u instanceof HTMLInputElement)){console.log("Error in editScene: Invalid choice input elements. Skipping choice.");continue}let A=u.value.trim(),Z=C.value.trim();A&&i.set(A,Z)}e.editScene(s,r,i)&&(p.render(e,s),a.show("Szene wurde erfolgreich bearbeitet.",n,!0))}static addChoiceField(e){if(!e){console.error("parentElement is not found.");return}let t=document.createElement("div");t.className="choice-inputs",t.innerHTML=`
        <input type="text" class="choice-text" placeholder="Entscheidungstext">
        <input type="text" class="choice-next" placeholder="N√§chste Szene (Schl√ºssel)">
      `,t.appendChild(g.#e(t)),e.appendChild(t)}static#e(e){let t=document.createElement("button");return t.classList.add("choiceform-delete"),t.setAttribute("aria-label","Choice l√∂schen"),t.textContent="üóë",t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),e.remove()}),t}};var d=new m(h),S=new B(d);function w(){if(!d.root){alert("Keine 'start'-Szene gefunden.");return}p.render(d,"start")}async function W(){let g=document.getElementById("json-file"),e=document.getElementById("import-status");if(!g.files.length){a.show("Bitte zuerst eine JSON-Datei ausw√§hlen.",e,!1);return}let t=g.files[0],n=URL.createObjectURL(t);try{if(d=await b.loadFromJson(n,h,m),!d){e.textContent="Fehler beim Laden: Story konnte nicht geladen werden.";return}S.story=d,a.show(`"${t.name}" erfolgreich geladen (${d.scenes.size} Szenen).`,e,!0),f.generateTreeAscii(d),y.render(d),w()}catch(o){a.show("Fehler beim Laden: "+o.message,e,!1)}finally{URL.revokeObjectURL(n)}}function k(){if(!d){a.show("No story available to export.",document.getElementById("import-status"),!1);return}b.saveToJson(d,"story.json")&&a.show("Story successfully exported to JSON.",document.getElementById("import-status"),!0)}function x(g){if(!d){a.show("No story available to export.",document.getElementById("import-status"),!1);return}let e=!1;g?e=b.saveToEncryptedHtml(d,"story.html","9oj7k&7C@b@W"):e=b.saveToHtml(d,"story.html"),e&&a.show("Story successfully exported to HTML.",document.getElementById("import-status"),!0)}function V(g){g==="default"?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",g)}function v(){let g=(e,t,n,o,c,s,r)=>{let i=document.getElementById(e),I=document.getElementById(t),l=document.getElementById(n),C=document.getElementById(o),u=document.getElementById(s),A=document.getElementById(c);I.addEventListener("click",function(){i.style.display="block"}),l.addEventListener("click",function(){i.style.display="none"}),window.addEventListener("click",function(Z){Z.target===i&&(i.style.display="none")}),C.addEventListener("click",function(){B.addChoiceField(u)}),A.addEventListener("click",function(){r(),i.style.display="none"})};g("create-scene-popup","showCreatorBtn","creator-closeBtn","creator-add-choice-btn","creator-submit-btn","creator-choices-container",function(){B.addScene(d)}),g("edit-scene-popup","showEditorBtn","editor-closeBtn","editor-add-choice-btn","editor-submit-btn","editor-choices-container",function(){B.editScene(d)})}window.renderScene=g=>p.render(d,g);window.removeScene=()=>S.removeScene();window.addEventListener("DOMContentLoaded",()=>{console.log("page is fully loaded"),document.getElementById("start-story").addEventListener("click",w),document.getElementById("btn-ascii-tree-refresh").addEventListener("click",()=>{f.generateTreeAscii(d)});let g=document.getElementById("btn-html-tree-refresh");g&&g.addEventListener("click",()=>y.render(d)),document.getElementById("import-json").addEventListener("click",W),document.getElementById("export-json").addEventListener("click",k),document.getElementById("export-html").addEventListener("click",()=>{let e=document.getElementById("export-antiscraping-check").checked;x(e)}),document.getElementById("theme-select").addEventListener("change",function(){V(this.value)}),v()});
//# sourceMappingURL=bundle.js.map</script>
</body>
